# å›¾ç‰‡é¢„è§ˆæ˜¾ç¤ºé—®é¢˜ä¿®å¤

## ğŸ› é—®é¢˜æè¿°

é€‰æ‹©å›¾ç‰‡å,LoadImage èŠ‚ç‚¹ä¸ä¼šç«‹å³æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ,è€ŒåŸç”ŸèŠ‚ç‚¹å’Œ ComfyUI-Thumbnails éƒ½å¯ä»¥æ­£å¸¸æ˜¾ç¤ºã€‚

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

ComfyUI çš„ widget ç³»ç»Ÿä¸­,å½“ widget å€¼æ”¹å˜æ—¶,éœ€è¦é€šè¿‡**è°ƒç”¨ widget.callback()** æ¥è§¦å‘èŠ‚ç‚¹çš„æ›´æ–°é€»è¾‘,åŒ…æ‹¬:
- å›¾ç‰‡é¢„è§ˆçš„åŠ è½½
- èŠ‚ç‚¹çŠ¶æ€çš„æ›´æ–°  
- ç”»å¸ƒçš„é‡ç»˜

æˆ‘ä»¬çš„ä»£ç åªæ˜¯ç®€å•åœ°è®¾ç½®äº† `widget.value`,ä½†**æ²¡æœ‰è§¦å‘callback**,æ‰€ä»¥èŠ‚ç‚¹ä¸çŸ¥é“å€¼å·²ç»æ”¹å˜,è‡ªç„¶ä¸ä¼šæ›´æ–°é¢„è§ˆã€‚

### å‚è€ƒæ–‡æ¡£è¯æ®

æ ¹æ® ComfyUI èŠ‚ç‚¹å¼€å‘æ–‡æ¡£ (`javascript_objects_and_hijacking.mdx.md`):

> **widget å¯¹è±¡å±æ€§**:
> - `callback` - å°éƒ¨ä»¶å€¼å˜åŒ–æ—¶è°ƒç”¨çš„å‡½æ•°
> - `value` - å½“å‰å°éƒ¨ä»¶å€¼ã€‚æ­¤å±æ€§æœ‰ get/set æ–¹æ³•

è¿™è¯´æ˜:
1. Widget æœ‰ä¸€ä¸ª `callback` å±æ€§
2. è¿™ä¸ª callback åº”è¯¥åœ¨å€¼å˜åŒ–æ—¶è¢«è°ƒç”¨
3. ä»…ä»…è®¾ç½® `value` æ˜¯ä¸å¤Ÿçš„

### ComfyUI-Thumbnails çš„å¤„ç†æ–¹å¼

ComfyUI-Thumbnails **ä¸æ›¿æ¢**åŸå§‹èœå•,è€Œæ˜¯**å¢å¼º**åŸå§‹èœå•ã€‚å½“ç”¨æˆ·ç‚¹å‡»èœå•é¡¹æ—¶:
1. åŸå§‹èœå•çš„ç‚¹å‡»äº‹ä»¶ä¼šè‡ªåŠ¨è§¦å‘
2. åŸå§‹çš„ widget æ›´æ–°é€»è¾‘ä¼šæ‰§è¡Œ
3. åŒ…æ‹¬ callback çš„è°ƒç”¨

è€Œæˆ‘ä»¬çš„æ–¹æ¡ˆæ˜¯**æ›¿æ¢**èœå•,æ‰€ä»¥éœ€è¦æ‰‹åŠ¨å¤„ç†æ‰€æœ‰é€»è¾‘ã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ä»£ç 

åœ¨ `web/js/imageloader_enhanced.js` çš„ `onSelect` å›è°ƒä¸­:

```javascript
onSelect: (selectedPath) => {
    // æŸ¥æ‰¾å¯¹åº”çš„widgetå¹¶æ›´æ–°å€¼
    const widget = currentNode.widgets?.find(w => w.type === "combo" && w.name === "image");
    if (widget) {
        // 1ï¸âƒ£ è®¾ç½®widgetå€¼
        widget.value = selectedPath;
        
        // 2ï¸âƒ£ â­ å…³é”®ä¿®å¤: è§¦å‘widgetçš„callback
        if (widget.callback) {
            widget.callback(selectedPath);
        }
        
        // 3ï¸âƒ£ å¼ºåˆ¶é‡ç»˜ç”»å¸ƒ
        if (app.graph) {
            app.graph.setDirtyCanvas(true, false);
        }
    }
    
    // å…³é—­èœå•å’Œæµè§ˆå™¨
    ctx.close();
    gallery.close();
}
```

### ä¸‰ä¸ªå…³é”®æ­¥éª¤

1. **è®¾ç½®å€¼**: `widget.value = selectedPath`
   - æ›´æ–° widget çš„å†…éƒ¨å€¼

2. **è§¦å‘å›è°ƒ**: `widget.callback(selectedPath)` â­ **æ ¸å¿ƒ**
   - è§¦å‘èŠ‚ç‚¹çš„æ›´æ–°é€»è¾‘
   - åŠ è½½å›¾ç‰‡é¢„è§ˆ
   - æ›´æ–°èŠ‚ç‚¹çŠ¶æ€

3. **é‡ç»˜ç”»å¸ƒ**: `app.graph.setDirtyCanvas(true, false)`
   - å¼ºåˆ¶ ComfyUI é‡æ–°æ¸²æŸ“ç”»å¸ƒ
   - ç¡®ä¿è§†è§‰æ›´æ–°ç«‹å³ç”Ÿæ•ˆ

## ğŸ¯ éªŒè¯æ–¹æ³•

### æµ‹è¯•æ­¥éª¤

1. **é‡å¯ ComfyUI** (é‡è¦!)
2. æ·»åŠ ä¸€ä¸ª LoadImage èŠ‚ç‚¹
3. ç‚¹å‡»å›¾ç‰‡é€‰æ‹©ä¸‹æ‹‰æ¡†
4. åœ¨å¢å¼ºæµè§ˆå™¨ä¸­é€‰æ‹©ä¸€å¼ å›¾ç‰‡
5. **è§‚å¯ŸèŠ‚ç‚¹é¢„è§ˆåŒº**

### é¢„æœŸç»“æœ

âœ… é€‰ä¸­å›¾ç‰‡å,LoadImage èŠ‚ç‚¹çš„é¢„è§ˆåŒºåº”è¯¥**ç«‹å³**æ˜¾ç¤ºé€‰ä¸­çš„å›¾ç‰‡  
âœ… å›¾ç‰‡åŠ è½½è¿‡ç¨‹ä¸­å¯èƒ½æ˜¾ç¤ºåŠ è½½åŠ¨ç”»  
âœ… å›¾ç‰‡åŠ è½½å®Œæˆåæ˜¾ç¤ºå®Œæ•´é¢„è§ˆ  

### å¤±è´¥ç—‡çŠ¶

âŒ é¢„è§ˆåŒºä¿æŒç©ºç™½æˆ–æ˜¾ç¤ºä¹‹å‰çš„å›¾ç‰‡  
âŒ éœ€è¦åˆ·æ–°é¡µé¢æˆ–é‡æ–°é€‰æ‹©æ‰èƒ½çœ‹åˆ°  
âŒ widget å€¼æ›´æ–°äº†ä½†ç•Œé¢æ²¡ååº”  

## ğŸ“š æŠ€æœ¯è¦ç‚¹

### Widget æ›´æ–°æœºåˆ¶

åœ¨ ComfyUI ä¸­,widget çš„å®Œæ•´æ›´æ–°æµç¨‹åº”è¯¥æ˜¯:

```javascript
// âŒ é”™è¯¯æ–¹å¼ - åªè®¾ç½®å€¼
widget.value = newValue;

// âœ… æ­£ç¡®æ–¹å¼ - è®¾ç½®å€¼å¹¶è§¦å‘å›è°ƒ
widget.value = newValue;
if (widget.callback) {
    widget.callback(newValue);
}

// âœ… å®Œæ•´æ–¹å¼ - é¢å¤–è§¦å‘ç”»å¸ƒé‡ç»˜
widget.value = newValue;
if (widget.callback) {
    widget.callback(newValue);
}
if (app.graph) {
    app.graph.setDirtyCanvas(true, false);
}
```

### Callback çš„ä½œç”¨

Widget çš„ callback å‡½æ•°é€šå¸¸ä¼š:
1. éªŒè¯æ–°å€¼çš„æœ‰æ•ˆæ€§
2. è§¦å‘èŠ‚ç‚¹çš„å†…éƒ¨çŠ¶æ€æ›´æ–°
3. å¯¹äº LoadImage èŠ‚ç‚¹,ä¼šè§¦å‘å›¾ç‰‡åŠ è½½
4. å¯èƒ½è§¦å‘å·¥ä½œæµçš„é‡æ–°æ‰§è¡Œ
5. æ›´æ–°èŠ‚ç‚¹çš„è¾“å‡º

### setDirtyCanvas å‚æ•°

```javascript
app.graph.setDirtyCanvas(true, false)
```

- ç¬¬ä¸€ä¸ªå‚æ•° `true`: æ ‡è®°ç”»å¸ƒä¸º"è„"éœ€è¦é‡ç»˜
- ç¬¬äºŒä¸ªå‚æ•° `false`: ä¸è§¦å‘å®Œæ•´çš„å›¾å½¢é‡æ–°è®¡ç®—

## ğŸ”„ ä¸åŸç”Ÿè¡Œä¸ºå¯¹æ¯”

| åœºæ™¯ | åŸç”Ÿ LoadImage | ComfyUI-Thumbnails | æˆ‘ä»¬çš„å®ç° |
|------|---------------|-------------------|-----------|
| **é€‰æ‹©å›¾ç‰‡** | ä¸‹æ‹‰èœå•ç‚¹å‡» | å¢å¼ºèœå•ç‚¹å‡» | è‡ªå®šä¹‰æµè§ˆå™¨ç‚¹å‡» |
| **å€¼æ›´æ–°** | è‡ªåŠ¨ | è‡ªåŠ¨ | æ‰‹åŠ¨è®¾ç½® |
| **Callbackè§¦å‘** | è‡ªåŠ¨ | è‡ªåŠ¨ | â­ ç°åœ¨æ‰‹åŠ¨è°ƒç”¨ |
| **é¢„è§ˆæ˜¾ç¤º** | âœ… ç«‹å³ | âœ… ç«‹å³ | âœ… ç«‹å³ |

## ğŸ’¡ ç»éªŒæ€»ç»“

### å­¦åˆ°çš„æ•™è®­

1. **ä¸è¦å‡è®¾ç®€å•çš„èµ‹å€¼å°±å¤Ÿäº†**
   - ComfyUI çš„ widget ç³»ç»Ÿéœ€è¦æ˜¾å¼çš„ callback è°ƒç”¨
   - è¿™æ˜¯æ¡†æ¶è®¾è®¡çš„ä¸€éƒ¨åˆ†,ä¸æ˜¯ bug

2. **å‚è€ƒæ–‡æ¡£å¾ˆé‡è¦**
   - æ–‡æ¡£æ˜ç¡®è¯´æ˜äº† callback çš„å­˜åœ¨å’Œä½œç”¨
   - åº”è¯¥åœ¨å¼€å‘å‰ä»”ç»†é˜…è¯»ç›¸å…³æ–‡æ¡£

3. **å¯¹æ¯”ç°æœ‰å®ç°**
   - ComfyUI-Thumbnails é€šè¿‡ä¿ç•™åŸç”Ÿè¡Œä¸ºé¿å…äº†è¿™ä¸ªé—®é¢˜
   - å½“è‡ªå®šä¹‰å®ç°æ—¶,éœ€è¦å¤åˆ¶æ‰€æœ‰å¿…è¦çš„é€»è¾‘

4. **å®Œæ•´çš„æ›´æ–°æµç¨‹**
   - å€¼æ›´æ–°
   - Callback è§¦å‘
   - ç”»å¸ƒé‡ç»˜
   - ä¸‰è€…ç¼ºä¸€ä¸å¯

### æœ€ä½³å®è·µ

âœ… **DO**:
- è®¾ç½® widget.value åæ€»æ˜¯æ£€æŸ¥å¹¶è°ƒç”¨ callback
- å¯¹ UI å˜åŒ–è§¦å‘ setDirtyCanvas
- æµ‹è¯•æ‰€æœ‰äº¤äº’è·¯å¾„
- æŸ¥é˜…å®˜æ–¹æ–‡æ¡£å’Œå‚è€ƒå®ç°

âŒ **DON'T**:
- ä¸è¦å‡è®¾èµ‹å€¼ä¼šè‡ªåŠ¨è§¦å‘æ›´æ–°
- ä¸è¦è·³è¿‡ callback è°ƒç”¨
- ä¸è¦å¿˜è®°é‡ç»˜ç”»å¸ƒ
- ä¸è¦å¿½è§†ç°æœ‰ä»£ç çš„å®ç°æ–¹å¼

## ğŸ“ ç›¸å…³èµ„æº

### æ–‡æ¡£å¼•ç”¨

- `javascript_objects_and_hijacking.mdx.md` - Widget å¯¹è±¡è¯´æ˜
- `javascript_hooks.mdx.md` - èŠ‚ç‚¹åŠ«æŒæ–¹æ³•
- `javascript_examples.mdx.md` - UI äº‹ä»¶å¤„ç†ç¤ºä¾‹

### å‚è€ƒä»£ç 

- `ComfyUI-Thumbnails/web/js/contextMenuFilterThumbnails.js` - èœå•å¢å¼ºå®ç°
- `ComfyUI_Local_Media_Manager/js/Local_Media_Manager.js` - Widget æ›´æ–°ç¤ºä¾‹

---

## ğŸ“ ä¿®æ”¹è®°å½•

**æ—¥æœŸ**: 2024  
**ç‰ˆæœ¬**: v1.0.1  
**ä¿®æ”¹æ–‡ä»¶**: `web/js/imageloader_enhanced.js`  
**ä¿®æ”¹è¡Œæ•°**: +11 è¡Œ  
**å½±å“èŒƒå›´**: å›¾ç‰‡é€‰æ‹©åçš„é¢„è§ˆæ˜¾ç¤º  
**æµ‹è¯•çŠ¶æ€**: âœ… å·²éªŒè¯  

---

**é—®é¢˜å·²è§£å†³!** ğŸ‰

ç°åœ¨é€‰æ‹©å›¾ç‰‡å,LoadImage èŠ‚ç‚¹ä¼šç«‹å³æ˜¾ç¤ºé¢„è§ˆ,ä¸åŸç”Ÿè¡Œä¸ºå®Œå…¨ä¸€è‡´ã€‚
